---
interface Props {}
---

<div class="cursor-trail-grid" id="cursor-trail-grid" aria-hidden="true">
	<!-- JS generates grid items here -->
</div>

<style>
	.cursor-trail-grid {
		position: fixed;
		inset: 0;
		z-index: 0;
		overflow: hidden;
		display: grid;
		pointer-events: none;
	}

	/* Grid lines via CSS gradient on the container (replaces canvas-drawn lines) */
	.cursor-trail-grid::before {
		content: '';
		position: absolute;
		inset: 0;
		pointer-events: none;
		background-image:
			linear-gradient(to right, var(--stroke-rgba) var(--stroke-width, 0.5px), transparent var(--stroke-width, 0.5px)),
			linear-gradient(to bottom, var(--stroke-rgba) var(--stroke-width, 0.5px), transparent var(--stroke-width, 0.5px));
		background-size: var(--grid-cell-size, 44px) var(--grid-cell-size, 44px);
		opacity: var(--grid-opacity, 1);
		z-index: 1;
	}

	.cursor-trail-grid__item {
		opacity: 0;
		background: var(--trail-color, #2dd4a0);
		transition:
			opacity var(--trail-fade-duration, 2s) ease var(--trail-fade-delay, 0.4s),
			transform 0.8s ease;
		transform: scale(1);
		pointer-events: none;
		will-change: opacity, transform;
	}

	.cursor-trail-grid__item.is-active {
		opacity: var(--trail-opacity, 0.6);
		transition:
			opacity 0s ease 0s,
			transform 0.3s ease;
		transform: scale(var(--trail-scale, 1.2));
	}

	@media (max-width: 767px) {
		.cursor-trail-grid {
			pointer-events: none;
			display: block;
		}

		.cursor-trail-grid__item {
			display: none;
		}
	}
</style>

<script>
	const STORAGE_KEY = 'cl01w-control';
	const MOBILE_BREAKPOINT = 767;
	const ACTIVE_CLASS = 'is-active';
	const ACTIVE_CLASS_MS = 90;

	function hexToRgba(hex, alpha) {
		const m = hex.replace(/^#/, '').match(/^([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i);
		if (!m) return `rgba(255, 255, 255, ${alpha})`;
		return `rgba(${parseInt(m[1], 16)}, ${parseInt(m[2], 16)}, ${parseInt(m[3], 16)}, ${alpha})`;
	}

	function getSettings() {
		try {
			const raw = localStorage.getItem(STORAGE_KEY);
			if (raw) return JSON.parse(raw);
		} catch (_) {}
		return {};
	}

	function getCellSize(settings) {
		const raw = Number(settings.cellSize);
		return Number.isFinite(raw) && raw > 0 ? raw : 44;
	}

	function initCursorTrailGrid() {
		const grid = document.getElementById('cursor-trail-grid');
		if (!grid) return;

		let cols = 0;
		let rows = 0;
		let cellSize = 44;
		let items = [];
		let prevCol = -1;
		let prevRow = -1;
		let resizeTimeout;
		const clearTimers = new Map();

		function clearGrid() {
			clearTimers.forEach((timerId) => window.clearTimeout(timerId));
			clearTimers.clear();
			grid.innerHTML = '';
			items = [];
			cols = 0;
			rows = 0;
			prevCol = -1;
			prevRow = -1;
		}

		function createGrid() {
			clearGrid();
			if (window.innerWidth <= MOBILE_BREAKPOINT) return;

			cols = Math.ceil(window.innerWidth / cellSize) + 1;
			rows = Math.ceil(window.innerHeight / cellSize) + 1;
			grid.style.gridTemplateColumns = `repeat(${cols}, ${cellSize}px)`;
			grid.style.gridTemplateRows = `repeat(${rows}, ${cellSize}px)`;

			const total = cols * rows;
			const fragment = document.createDocumentFragment();
			items = new Array(total);
			for (let i = 0; i < total; i++) {
				const item = document.createElement('div');
				item.className = 'cursor-trail-grid__item';
				items[i] = item;
				fragment.appendChild(item);
			}
			grid.appendChild(fragment);
		}

		function applySettings(settings) {
			const s = settings || getSettings();
			const root = document.documentElement;
			cellSize = getCellSize(s);

			root.style.setProperty('--trail-color', s.highlightColor || '#001a2b');
			root.style.setProperty('--trail-opacity', String((s.highlightOpacity ?? 20) / 100));
			root.style.setProperty('--trail-fade-duration', `${s.trailFadeDuration ?? 2}s`);
			root.style.setProperty('--trail-fade-delay', `${s.trailFadeDelay ?? 0.4}s`);
			root.style.setProperty('--trail-scale', String(s.trailScale ?? 1.2));
			root.style.setProperty('--grid-cell-size', `${cellSize}px`);
			root.style.setProperty('--grid-opacity', String((s.gridOpacity ?? 100) / 100));

			const strokeAlpha = Math.max(0, Math.min(100, s.strokeOpacity ?? 35)) / 100;
			root.style.setProperty('--stroke-rgba', hexToRgba(s.strokeColor || '#8f62ff', strokeAlpha));
			root.style.setProperty('--stroke-width', `${s.strokeWidth ?? 0.5}px`);
		}

		function activateCell(cellIndex) {
			if (cellIndex < 0 || cellIndex >= items.length) return;
			const item = items[cellIndex];
			if (!item) return;

			item.classList.add(ACTIVE_CLASS);
			if (clearTimers.has(cellIndex)) {
				window.clearTimeout(clearTimers.get(cellIndex));
			}

			const timeoutId = window.setTimeout(() => {
				item.classList.remove(ACTIVE_CLASS);
				clearTimers.delete(cellIndex);
			}, ACTIVE_CLASS_MS);
			clearTimers.set(cellIndex, timeoutId);
		}

		function activateAlongPath(fromCol, fromRow, toCol, toRow) {
			if (fromCol < 0 || fromRow < 0) {
				activateCell(toRow * cols + toCol);
				return;
			}

			const dCol = toCol - fromCol;
			const dRow = toRow - fromRow;
			const steps = Math.max(Math.abs(dCol), Math.abs(dRow), 1);
			for (let i = 1; i <= steps; i++) {
				const col = Math.round(fromCol + (dCol * i) / steps);
				const row = Math.round(fromRow + (dRow * i) / steps);
				activateCell(row * cols + col);
			}
		}

		function onPointerMove(event) {
			if (window.innerWidth <= MOBILE_BREAKPOINT || !cols || !rows) return;

			const x = event.clientX;
			const y = event.clientY;
			if (x < 0 || y < 0 || x >= window.innerWidth || y >= window.innerHeight) {
				prevCol = -1;
				prevRow = -1;
				return;
			}

			const col = Math.max(0, Math.min(cols - 1, Math.floor(x / cellSize)));
			const row = Math.max(0, Math.min(rows - 1, Math.floor(y / cellSize)));
			if (col === prevCol && row === prevRow) return;

			activateAlongPath(prevCol, prevRow, col, row);
			prevCol = col;
			prevRow = row;
		}

		function onPointerLeave() {
			prevCol = -1;
			prevRow = -1;
		}

		function onResize() {
			window.clearTimeout(resizeTimeout);
			resizeTimeout = window.setTimeout(() => {
				applySettings();
				createGrid();
			}, 150);
		}

		function onSettings(event) {
			applySettings(event?.detail || getSettings());
			if (event?.detail?.cellSize != null) createGrid();
		}

		applySettings();
		createGrid();
		window.addEventListener('pointermove', onPointerMove, { passive: true });
		document.addEventListener('mouseleave', onPointerLeave);
		window.addEventListener('blur', onPointerLeave);
		window.addEventListener('resize', onResize);
		window.addEventListener('cl01w-settings', onSettings);
	}

	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', initCursorTrailGrid, { once: true });
	} else {
		initCursorTrailGrid();
	}
</script>
