---
interface Props {
	src: string;
	title?: string;
	poster?: string;
}

function parseTimeToSeconds(raw: string | null): string | null {
	if (!raw) return null;
	if (/^\d+$/.test(raw)) return raw;
	const match = raw.match(/^(?:(\d+)h)?(?:(\d+)m)?(?:(\d+)s)?$/i);
	if (!match) return null;
	const hours = Number(match[1] ?? 0);
	const minutes = Number(match[2] ?? 0);
	const seconds = Number(match[3] ?? 0);
	const total = hours * 3600 + minutes * 60 + seconds;
	return total ? String(total) : null;
}

function toYouTubeEmbed(url: string): string {
	try {
		const parsed = new URL(url);
		const host = parsed.hostname.replace(/^www\./, '');
		const isShort = host === 'youtu.be';
		const isYouTube = host === 'youtube.com' || host === 'm.youtube.com' || host === 'youtube-nocookie.com';
		let id = '';

		if (isShort) {
			id = parsed.pathname.slice(1).split('/')[0] ?? '';
		} else if (isYouTube || host.endsWith('youtube.com')) {
			if (parsed.pathname.startsWith('/watch')) {
				id = parsed.searchParams.get('v') ?? '';
			} else if (parsed.pathname.startsWith('/embed/')) {
				id = parsed.pathname.split('/')[2] ?? '';
			} else if (parsed.pathname.startsWith('/shorts/')) {
				id = parsed.pathname.split('/')[2] ?? '';
			}
		}

		if (!id) return url;

		const embedBase = host === 'youtube-nocookie.com'
			? 'https://www.youtube-nocookie.com/embed/'
			: 'https://www.youtube.com/embed/';
		const params = new URLSearchParams();
		const start = parseTimeToSeconds(parsed.searchParams.get('t')) ?? parseTimeToSeconds(parsed.searchParams.get('start'));
		if (start) params.set('start', start);
		const list = parsed.searchParams.get('list');
		if (list) params.set('list', list);
		params.set('rel', '0');
		const query = params.toString();
		return `${embedBase}${id}${query ? `?${query}` : ''}`;
	} catch {
		return url;
	}
}

function toYouTubeId(url: string): string | null {
	try {
		const parsed = new URL(url);
		const host = parsed.hostname.replace(/^www\./, '');
		const isShort = host === 'youtu.be';
		const isYouTube = host === 'youtube.com' || host === 'm.youtube.com' || host === 'youtube-nocookie.com';

		if (isShort) return parsed.pathname.slice(1).split('/')[0] ?? null;
		if (!isYouTube && !host.endsWith('youtube.com')) return null;

		if (parsed.pathname.startsWith('/watch')) return parsed.searchParams.get('v');
		if (parsed.pathname.startsWith('/embed/')) return parsed.pathname.split('/')[2] ?? null;
		if (parsed.pathname.startsWith('/shorts/')) return parsed.pathname.split('/')[2] ?? null;
		return null;
	} catch {
		return null;
	}
}

function toYouTubeThumbnail(url: string): string | null {
	const id = toYouTubeId(url);
	if (!id) return null;
	return `https://img.youtube.com/vi/${id}/hqdefault.jpg`;
}

const { src, title = 'Video', poster } = Astro.props;
const embedSrc = toYouTubeEmbed(src);
const youtubeThumb = toYouTubeThumbnail(src);
const thumbSrc = poster || youtubeThumb;
const thumbStyle = thumbSrc ? `background-image: url('${thumbSrc}');` : undefined;
---

<div class="video-embed">
	<button
		type="button"
		class="video-embed__trigger"
		style={thumbStyle}
		data-lightbox
		data-lightbox-src={embedSrc}
		data-lightbox-type="video"
		data-lightbox-title={title}
	>
		<span class="video-embed__play" aria-hidden="true">â–¶</span>
		<span class="video-embed__label">Play video</span>
	</button>
</div>

<style>
	.video-embed {
		margin: 24px 50px;
	}

	.video-embed__trigger {
		position: relative;
		display: flex;
		align-items: center;
		justify-content: center;
		gap: 12px;
		width: 100%;
		min-height: 200px;
		padding: 32px;
		background: var(--codeblock-bg);
		background-size: cover;
		background-position: center;
		background-repeat: no-repeat;
		border: 1px solid var(--snippet-border);
		cursor: pointer;
		font-family: var(--font-body);
		font-size: 16px;
		color: var(--content-caption);
		transition: border-color 0.15s ease, background 0.15s ease;
	}

	.video-embed__trigger::before {
		content: '';
		position: absolute;
		inset: 0;
		background: linear-gradient(180deg, rgba(5, 18, 28, 0.75) 0%, rgba(5, 18, 28, 0.75) 100%);
		opacity: 0;
		transition: opacity 0.15s ease;
	}

	.video-embed__trigger:hover {
		border-color: var(--meta-border);
		background: #0f2635;
	}

	.video-embed__trigger:hover::before {
		opacity: 1;
	}

	.video-embed__play {
		display: flex;
		align-items: center;
		justify-content: center;
		width: 56px;
		height: 56px;
		font-size: 24px;
		color: var(--content-title);
		position: relative;
		z-index: 1;
	}

	.video-embed__label {
		position: relative;
		z-index: 1;
	}

	@media (max-width: 767px) {
		.video-embed {
			margin: 24px 0;
		}
	}
</style>
