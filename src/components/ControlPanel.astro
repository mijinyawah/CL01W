---
interface Props {}
---

<div id="control-panel" class="control-panel" role="dialog" aria-label="Try the control panel" aria-modal="true" hidden>
	<div class="control-panel__backdrop" data-close-panel></div>
	<div class="control-panel__card">
		<div class="control-panel__header">
			<h2 class="control-panel__title">Try the control panel</h2>
			<button type="button" class="control-panel__close" data-close-panel aria-label="Close">×</button>
		</div>
		<div class="control-panel__body">
			<fieldset class="control-panel__section">
				<legend>Colors</legend>
				<label class="control-panel__row">
					<span>Stroke</span>
					<input type="color" id="stroke-color" value="#ffffff" data-setting="strokeColor" />
				</label>
				<label class="control-panel__row">
					<span>Background</span>
					<input type="color" id="page-bg" value="#ded5ea" data-setting="pageBg" />
				</label>
				<label class="control-panel__row">
					<span>Cursor & trail</span>
					<input type="color" id="cursor-fill" value="#2dd4a0" data-setting="cursorFill" />
				</label>
			</fieldset>
			<fieldset class="control-panel__section">
				<legend>Randomize</legend>
				<button type="button" id="randomize-grid" class="control-panel__randomize">Randomize the grid</button>
			</fieldset>
		</div>
	</div>
</div>

<style>
	.control-panel {
		position: fixed;
		inset: 0;
		z-index: 10001;
		display: flex;
		align-items: flex-end;
		justify-content: flex-end;
		padding: 20px;
		pointer-events: none;
	}

	.control-panel[hidden] {
		display: none !important;
	}

	.control-panel.is-open {
		pointer-events: auto;
	}

	.control-panel__backdrop {
		position: absolute;
		inset: 0;
		background: rgba(0, 0, 0, 0.3);
		cursor: pointer;
	}

	.control-panel__card {
		position: relative;
		width: 360px;
		max-height: 80vh;
		overflow-y: auto;
		background: #0d1316;
		border: 2px solid #2dd4a0;
		padding: 14px 18px;
		box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
	}

	.control-panel__header {
		display: flex;
		align-items: center;
		justify-content: space-between;
		margin-bottom: 10px;
		padding-bottom: 8px;
		border-bottom: 1px solid rgba(45, 212, 160, 0.3);
	}

	.control-panel__title {
		font-family: var(--font-sidebar);
		font-size: 14px;
		font-weight: 700;
		color: rgba(255, 255, 255, 0.9);
		margin: 0;
	}

	.control-panel__close {
		width: 32px;
		height: 32px;
		display: flex;
		align-items: center;
		justify-content: center;
		font-size: 24px;
		line-height: 1;
		color: rgba(255, 255, 255, 0.8);
		background: transparent;
		border: none;
		cursor: pointer;
	}

	.control-panel__close:hover {
		color: #2dd4a0;
	}

	.control-panel__section {
		margin: 0 0 12px;
		padding: 0;
		border: none;
	}

	.control-panel__section legend {
		font-family: var(--font-sidebar);
		font-size: 11px;
		font-weight: 600;
		text-transform: uppercase;
		color: #2dd4a0;
		margin-bottom: 6px;
		padding: 0;
	}

	.control-panel__row {
		display: flex;
		align-items: center;
		gap: 8px;
		margin-bottom: 6px;
		font-family: var(--font-sidebar);
		font-size: 12px;
		color: rgba(255, 255, 255, 0.8);
	}

	.control-panel__row span:first-child {
		flex: 0 0 72px;
	}

	.control-panel__row input[type='range'] {
		flex: 1;
		min-width: 0;
		accent-color: #2dd4a0;
	}

	.control-panel__row input[type='color'] {
		width: 32px;
		height: 28px;
		padding: 0;
		border: 1px solid rgba(255, 255, 255, 0.2);
		cursor: pointer;
	}

	.control-panel__row--toggle {
		cursor: pointer;
	}

	.control-panel__row--toggle input {
		accent-color: #2dd4a0;
	}

	.control-panel__row output {
		flex: 0 0 28px;
		text-align: right;
	}

	.control-panel__randomize {
		width: 100%;
		padding: 10px 14px;
		font-family: var(--font-sidebar);
		font-size: 13px;
		font-weight: 600;
		color: #0d1316;
		background: #2dd4a0;
		border: none;
		cursor: pointer;
	}

	.control-panel__randomize:hover {
		background: #3ee5b0;
	}
</style>

<script>
	const STORAGE_KEY = 'cl01w-control';

	const DEFAULTS = {
		strokeColor: '#ffffff',
		pageBg: '#ded5ea',
		cursorFill: '#2dd4a0',
		gridOpacity: 100,
		gridGlow: 100,
		strokeOpacity: 100,
		strokeWidth: 0.5,
		cellSize: 44,
		highlightColor: '#001a2b',
		highlightOpacity: 20,
		customCursor: true,
		cursorSize: 8,
		cursorOpacity: 80,
		trailLength: 8,
		trailTightness: 50,
		trailOpacity: 100,
	};

	/** HSL (h 0–360, s/l 0–100) to hex */
	function hslToHex(h, s, l) {
		s /= 100;
		l /= 100;
		const a = s * Math.min(l, 1 - l);
		const f = (n) => {
			const k = (n + h / 30) % 12;
			return l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
		};
		return '#' + [f(0), f(8), f(4)].map((x) => Math.round(x * 255).toString(16).padStart(2, '0')).join('');
	}

	const rand = (min, max) => Math.random() * (max - min) + min;
	const randInt = (min, max) => Math.floor(rand(min, max + 0.999));

	/** Pick HSL from range arrays [min, max] */
	function hslFromRange(hRange, sRange, lRange) {
		return hslToHex(randInt(hRange[0], hRange[1]), randInt(sRange[0], sRange[1]), randInt(lRange[0], lRange[1]));
	}

	/** Map opacity 0.4–1.0 to stored 0–100 */
	function opacityToStored(o) {
		return Math.round(Math.max(0, Math.min(100, ((o - 0.4) / 0.6) * 100)));
	}

	const MOODS = {
		neon: {
			stroke: { h: [170, 320], s: [90, 100], l: [50, 70], opacity: [0.7, 1.0] },
			bg: { h: [220, 280], s: [30, 60], l: [5, 15] },
			trail: { h: [150, 330], s: [90, 100], l: [55, 75], opacity: [0.7, 1.0] },
			highlight: { h: [160, 300], s: [80, 100], l: [45, 65] },
			trailLength: [15, 30],
			strokeWidth: [1, 2],
			cursorSize: [8, 16],
			cursorOpacity: [0.7, 1.0],
			trailTightness: [40, 80],
			gridOpacity: [80, 100],
			gridGlow: [70, 100],
			cellSize: [24, 40],
			highlightOpacity: [40, 80],
		},
		midnight: {
			stroke: { h: [200, 270], s: [60, 90], l: [40, 65], opacity: [0.5, 0.9] },
			bg: { h: [220, 250], s: [40, 70], l: [8, 20] },
			trail: { h: [200, 280], s: [70, 100], l: [50, 70], opacity: [0.6, 0.9] },
			highlight: { h: [210, 260], s: [60, 90], l: [35, 55] },
			trailLength: [10, 25],
			strokeWidth: [0.5, 1.5],
			cursorSize: [6, 14],
			cursorOpacity: [0.6, 0.9],
			trailTightness: [30, 70],
			gridOpacity: [70, 100],
			gridGlow: [50, 90],
			cellSize: [20, 38],
			highlightOpacity: [30, 70],
		},
		ember: {
			stroke: { h: [0, 45], s: [80, 100], l: [45, 65], opacity: [0.6, 1.0] },
			bg: { h: [10, 30], s: [40, 70], l: [8, 18] },
			trail: { h: [20, 50], s: [85, 100], l: [50, 70], opacity: [0.7, 1.0] },
			highlight: { h: [15, 40], s: [75, 100], l: [40, 60] },
			trailLength: [12, 25],
			strokeWidth: [1, 2],
			cursorSize: [8, 18],
			cursorOpacity: [0.6, 1.0],
			trailTightness: [35, 75],
			gridOpacity: [75, 100],
			gridGlow: [60, 100],
			cellSize: [22, 42],
			highlightOpacity: [35, 75],
		},
		matrix: {
			stroke: { h: [110, 140], s: [80, 100], l: [40, 60], opacity: [0.7, 1.0] },
			bg: { h: [120, 140], s: [20, 40], l: [3, 10] },
			trail: { h: [115, 145], s: [85, 100], l: [45, 65], opacity: [0.8, 1.0] },
			highlight: { h: [115, 135], s: [70, 100], l: [35, 55] },
			trailLength: [20, 30],
			strokeWidth: [0.5, 1],
			cursorSize: [6, 12],
			cursorOpacity: [0.7, 1.0],
			trailTightness: [50, 90],
			gridOpacity: [80, 100],
			gridGlow: [40, 80],
			cellSize: [20, 36],
			highlightOpacity: [40, 80],
		},
		vapor: {
			stroke: { h: [270, 340], s: [70, 100], l: [55, 75], opacity: [0.6, 0.9] },
			bg: { h: [260, 300], s: [30, 60], l: [10, 22] },
			trail: { h: [160, 200], s: [70, 100], l: [55, 70], opacity: [0.6, 0.9] },
			highlight: { h: [280, 320], s: [60, 95], l: [50, 70] },
			trailLength: [15, 28],
			strokeWidth: [1, 2],
			cursorSize: [10, 20],
			cursorOpacity: [0.6, 0.9],
			trailTightness: [20, 60],
			gridOpacity: [70, 100],
			gridGlow: [50, 90],
			cellSize: [24, 44],
			highlightOpacity: [35, 70],
		},
		mono: {
			stroke: { h: [0, 0], s: [0, 5], l: [70, 100], opacity: [0.6, 1.0] },
			bg: { h: [0, 0], s: [0, 5], l: [2, 8] },
			trail: { h: [0, 0], s: [0, 5], l: [80, 100], opacity: [0.7, 1.0] },
			highlight: { h: [0, 0], s: [0, 10], l: [60, 90] },
			trailLength: [10, 20],
			strokeWidth: [1, 2],
			cursorSize: [6, 12],
			cursorOpacity: [0.7, 1.0],
			trailTightness: [40, 80],
			gridOpacity: [85, 100],
			gridGlow: [30, 70],
			cellSize: [28, 44],
			highlightOpacity: [40, 80],
		},
	};

	function load() {
		try {
			const raw = localStorage.getItem(STORAGE_KEY);
			if (raw) {
				const parsed = JSON.parse(raw);
				return { ...DEFAULTS, ...parsed };
			}
		} catch (_) {}
		return { ...DEFAULTS };
	}

	function save(settings) {
		localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
		window.dispatchEvent(new CustomEvent('cl01w-settings', { detail: settings }));
	}

	function applyPageBg(hex) {
		document.body.style.setProperty('--page-bg', hex);
	}

	function runRandomize(settings) {
		const moodNames = Object.keys(MOODS);
		const mood = MOODS[moodNames[randInt(0, moodNames.length - 1)]];
		const m = mood;

		settings.strokeColor = hslFromRange(m.stroke.h, m.stroke.s, m.stroke.l);
		settings.strokeOpacity = opacityToStored(rand(m.stroke.opacity[0], m.stroke.opacity[1]));
		settings.strokeWidth = Math.round(rand(m.strokeWidth[0], m.strokeWidth[1]) * 10) / 10;
		settings.pageBg = hslFromRange(m.bg.h, m.bg.s, m.bg.l);
		settings.cursorFill = hslFromRange(m.trail.h, m.trail.s, m.trail.l);
		settings.highlightColor = hslFromRange(m.highlight.h, m.highlight.s, m.highlight.l);

		settings.trailLength = randInt(m.trailLength[0], m.trailLength[1]);
		settings.trailOpacity = randInt(Math.round(m.trail.opacity[0] * 100), Math.round(m.trail.opacity[1] * 100));
		settings.trailTightness = randInt(m.trailTightness[0], m.trailTightness[1]);
		settings.cursorSize = randInt(m.cursorSize[0], m.cursorSize[1]);
		settings.cursorOpacity = randInt(Math.round(m.cursorOpacity[0] * 100), Math.round(m.cursorOpacity[1] * 100));
		settings.customCursor = true;

		settings.gridOpacity = randInt(m.gridOpacity[0], m.gridOpacity[1]);
		settings.gridGlow = randInt(m.gridGlow[0], m.gridGlow[1]);
		settings.cellSize = randInt(m.cellSize[0], m.cellSize[1]);
		settings.highlightOpacity = randInt(m.highlightOpacity[0], m.highlightOpacity[1]);
	}

	function init() {
		const panel = document.getElementById('control-panel');
		const toggle = document.getElementById('control-panel-toggle');
		if (!panel || !toggle) return;

		const settings = load();
		applyPageBg(settings.pageBg);

		panel.querySelectorAll('[data-setting]').forEach((input) => {
			const key = input.dataset.setting;
			if (key in settings && input.type === 'color') {
				input.value = settings[key];
			}
			input.addEventListener('change', () => {
				settings[key] = input.value;
				save(settings);
				if (key === 'pageBg') applyPageBg(settings.pageBg);
			});
		});

		const randomizeBtn = document.getElementById('randomize-grid');
		if (randomizeBtn) {
			randomizeBtn.addEventListener('click', () => {
				runRandomize(settings);
				// Sync color inputs so pickers show new values
				const strokeInput = document.getElementById('stroke-color');
				const pageBgInput = document.getElementById('page-bg');
				const cursorInput = document.getElementById('cursor-fill');
				if (strokeInput) strokeInput.value = settings.strokeColor;
				if (pageBgInput) pageBgInput.value = settings.pageBg;
				if (cursorInput) cursorInput.value = settings.cursorFill;
				applyPageBg(settings.pageBg);
				save(settings);
			});
		}

		window.addEventListener('cl01w-settings', (e) => {
			if (e.detail && e.detail.pageBg) applyPageBg(e.detail.pageBg);
		});

		function open() {
			panel.hidden = false;
			panel.classList.add('is-open');
		}

		function close() {
			panel.hidden = true;
			panel.classList.remove('is-open');
		}

		toggle?.addEventListener('click', (e) => {
			e.preventDefault();
			if (panel.hidden) open();
			else close();
		});

		panel.querySelectorAll('[data-close-panel]').forEach((el) => el.addEventListener('click', close));

		document.addEventListener('keydown', (e) => {
			if (e.key === 'Escape' && panel.classList.contains('is-open')) close();
		});
	}

	document.addEventListener('DOMContentLoaded', init);
</script>
