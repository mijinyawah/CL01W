---
interface Props {}
---

<div class="cursor-trail" id="cursor-trail" aria-hidden="true"></div>

<style is:global>
	body {
		position: relative;
	}
</style>

<style>
	.cursor-trail {
		position: fixed;
		inset: 0;
		pointer-events: none;
		z-index: 9999;
	}

	/* Disable on touch devices / mobile â€” no hover */
	@media (max-width: 800px) {
		.cursor-trail {
			display: none;
		}
	}

	.cursor-trail__dot {
		position: absolute;
		border-radius: 50%;
		transform: translate(-50%, -50%);
		left: 0;
		top: 0;
	}
</style>

<script>
	const STORAGE_KEY = 'cl01w-control';
	const MAX_DOTS = 50;
	const SIZE_START = 6;
	const SIZE_END = 2;
	const OPACITY_START = 0.9;
	const OPACITY_END = 0.2;

	function getSettings() {
		try {
			const raw = localStorage.getItem(STORAGE_KEY);
			if (raw) {
				const p = JSON.parse(raw);
				return {
					cursorFill: p.cursorFill || '#2dd4a0',
					trailLength: Math.min(50, Math.max(0, Number(p.trailLength) ?? 8)),
					trailTightness: Math.min(100, Math.max(0, Number(p.trailTightness) ?? 50)),
					trailOpacity: Math.min(100, Math.max(0, Number(p.trailOpacity) ?? 100)),
				};
			}
		} catch (_) {}
		return {
			cursorFill: '#2dd4a0',
			trailLength: 8,
			trailTightness: 50,
			trailOpacity: 100,
		};
	}

	function init() {
		const container = document.getElementById('cursor-trail');
		if (!container) return;

		// Create dot elements (max 50; length 0 = no trail)
		const dots: HTMLElement[] = [];
		for (let i = 0; i < MAX_DOTS; i++) {
			const el = document.createElement('div');
			el.className = 'cursor-trail__dot';
			el.setAttribute('data-dot', String(i));
			container.appendChild(el);
			dots.push(el);
		}

		let settings = getSettings();
		const positions = Array.from({ length: MAX_DOTS }, () => ({ x: 0, y: 0 }));
		let mouseX = 0;
		let mouseY = 0;

		// Tightness 0 = chunky (low lerp, spread out), 100 = smooth (high lerp, follows closely)
		function getLerpFactor(): number {
			const lerpLo = 0.02;
			const lerpHi = 0.35;
			const tight = settings.trailTightness / 100;
			return lerpLo + (lerpHi - lerpLo) * tight;
		}

		function getSize(index: number, count: number): number {
			if (count <= 1) return SIZE_START;
			const t = index / (count - 1);
			return SIZE_START + (SIZE_END - SIZE_START) * t;
		}

		function getBaseOpacity(index: number, count: number): number {
			if (count <= 1) return OPACITY_START;
			const t = index / (count - 1);
			return OPACITY_START + (OPACITY_END - OPACITY_START) * t;
		}

		function applySettings() {
			const n = settings.trailLength;
			const trailMult = settings.trailOpacity / 100; // 0 = invisible, 100 = full
			dots.forEach((el, i) => {
				el.style.display = i < n ? 'block' : 'none';
				if (i < n) {
					el.style.background = settings.cursorFill;
					const baseOp = n <= 1 ? OPACITY_START : getBaseOpacity(i, n);
					el.style.opacity = String(baseOp * trailMult);
					const size = getSize(i, n);
					el.style.width = `${size}px`;
					el.style.height = `${size}px`;
				}
			});
		}

		function tick() {
			const n = settings.trailLength;
			if (n === 0) {
				requestAnimationFrame(tick);
				return;
			}

			positions[0].x = mouseX;
			positions[0].y = mouseY;

			const lerp = getLerpFactor();
			for (let i = 1; i < n; i++) {
				positions[i].x += (positions[i - 1].x - positions[i].x) * lerp;
				positions[i].y += (positions[i - 1].y - positions[i].y) * lerp;
			}

			dots.forEach((el, i) => {
				if (i < n) {
					el.style.left = `${positions[i].x}px`;
					el.style.top = `${positions[i].y}px`;
				}
			});

			requestAnimationFrame(tick);
		}

		function onMouseMove(e: MouseEvent) {
			mouseX = e.clientX;
			mouseY = e.clientY;
			document.body.style.setProperty('--mouse-x', `${mouseX}px`);
			document.body.style.setProperty('--mouse-y', `${mouseY}px`);
		}

		window.addEventListener('cl01w-settings', ((e: CustomEvent) => {
			settings = { ...settings, ...e.detail };
			settings.trailLength = Math.min(50, Math.max(0, settings.trailLength ?? 8));
			applySettings();
		}) as EventListener);

		applySettings();
		requestAnimationFrame(tick);
		document.addEventListener('mousemove', onMouseMove, { passive: true });
	}

	document.addEventListener('DOMContentLoaded', init);
</script>
